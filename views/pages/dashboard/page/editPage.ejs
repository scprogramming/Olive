<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <link rel="stylesheet" href="/public/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/public/addPage.css">
    
  </head>

  <body>

    <div class="page-container">
      <div class="content-wrap">
          <div class="row">
              <%- include('../navbar.ejs'); %>
          </div>
          <div class="row">
              <div class="col-2">
                  <%- include('../sidebar.ejs'); %>
              </div>
              <div class="col-8">
                <input type="text" class="form-control" id="pageTitle" value=<%= title %>>     
                <button class="btn btn-primary" onclick="saveTitle()">Save Title</button>
                <p id="status"></p>
                <div id="pageContent">
                  <a href="/dashboard/addBlock/<%=pageId %>/hero">Primary Button</a>     
                    <% for (var i = 0; i < content.length; i++){ %>

                      <div class="buttonOverlay" id = '<%- i %>buttons'>
                        <a onclick="editBlock('<%=pageId%>','hero','<%- i %>');"><i class="fa fa-edit"></i></button></a>  
                        <a onclick="deleteBlock('<%- i %>');"><i class="fa fa-trash"></i></button></a>  
                      </div>
                      <div id='<%- i %>' draggable="true" class="draggable"> <%- content[i].content %> </div>
                  <%}%>
                </div>
                
              </div>
            </div>
      </div>
  </div>

  
</body>
 
<script>

  let dragSrcEl = "";

  function handleDrop(e){
    e.stopPropagation();
    if (dragSrcEl !== this){
      dragSrcEl.innerHTML = this.innerHTML;
      this.innerHTML = e.dataTransfer.getData('text/html');

      const dragSrcId = dragSrcEl.id;
      const currentId = this.id;

      fetch('<%- url %>:<%- port %>/api/updatePageOrder/', {
        method:'POST',
        headers: {
                    "Content-Type": "application/json"
                },
        credentials:'include',
        body:JSON.stringify({block_id1:dragSrcId, block_id2: currentId, page_id: '<%= pageId %>'})
      });

    }

    return false;
  }

  function handleDragOver(e) {
    e.preventDefault();
    return false;
  }

  function handleDragStart(e){
    this.style.opacity = '0.4';
    dragSrcEl = this;

    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html',this.innerHTML);
  }

  function handleDragEnd(e){
    this.style.opacity = '1';
  }


    function deleteBlock(blockId){
      fetch('<%- url %>:<%- port %>/api/deleteBlock/', {
        method:'POST',
        headers: {
                    "Content-Type": "application/json"
                },
        credentials:'include',
        body:JSON.stringify({block_id:blockId, page_id: '<%= pageId %>'})
      })
      .then(res => res.json());

      document.getElementById(blockId).remove();
      document.getElementById(blockId + 'buttons').remove();
    }

    function editBlock(pageId,editType,block){
      location.href = `/dashboard/editBlock/${pageId}/${editType}/${block}`
    }

    function saveTitle(){

        let title = document.getElementById("pageTitle").value;

        fetch('<%= url %>:<%= port %>/api/editPageTitle', {
                method:'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: 'include',
                body:JSON.stringify({page_id:'<%= pageId %>', title:title})
                
            }).then(res => setResult(res));
    }

    async function setResult(res){
      let result = await res.json();
      document.getElementById("status").innerHTML = result.status;
    }

    let items = document.querySelectorAll('.draggable');
    items.forEach(function (item){
      item.addEventListener('dragstart',handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
      item.addEventListener('drop',handleDrop);
      item.addEventListener('dragover',handleDragOver);
    });

  
</script>


</html>