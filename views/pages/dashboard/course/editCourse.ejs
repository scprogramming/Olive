<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <link rel="stylesheet" href="/public/sidebar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/public/editCourse.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    
  </head>

  <body>

    <div class="page-container">
      <div class="content-wrap">
          <div class="row">
              <%- include('../navbar.ejs'); %>
          </div>
          <div class="row">
              <div class="col-2">
                  <%- include('../sidebar.ejs'); %>
              </div>
              <div class="col-10">
                <input type="text" class="form-control" id="courseTitle" value=<%-content.course_title%>>     
                <button class="btn btn-primary" onclick="saveTitle()">Save Title</button>
                <p id="status"></p>
                <div id="pageContent">
                  <div class="tab">
                    <button class="tablinks" onclick="openSection(event,'curriculum','tabcontent','tablinks')">Curriculum</button>
                    <button class="tablinks" onclick="openSection(event,'pricing','tabcontent','tablinks')">Pricing</button>
                    <button class="tablinks" onclick="openSection(event, 'courseDetails', 'tabcontent', 'tablinks')">Course Details</button>
                  </div>

                  <div id="courseDetails" class="tabcontent" style="display:none;">
                    <h3>What you'll learn</h3>
                    <div id="learningObjectives">
                      <% for (let i = 0; i < content.learning_objectives.length; i++){%>
                        <p><%-content.learning_objectives[i]%></p>
                      <%}%>
                    </div>
                    <div id="newLearnObj">

                    </div>
                    <button class="button btn-primary" onclick="promptTitle('newLearnObj','newLearningObjective','Input module name',
                    'addCourseDetailField(\'newLearningObjective\',\'/api/addLearningObjective\',\'learningObj\',\'newLearnObj\',\'learningObjectives\')')">Add learning objective</button>

                    <h3>Requirements</h3>
                    <div id="requirements">
                      <% for (let i = 0; i < content.requirements.length; i++){%>
                        <p><%-content.requirements[i]%></p>
                      <%}%>
                    </div>
                    <div id="newRequirements">

                    </div>
                    <button class="button btn-primary" onclick="promptTitle('newRequirements','newRequirementsValue','Input requirement',
  'addCourseDetailField(\'newRequirementsValue\', \'/api/newRequirement\',\'requirement\',\'newRequirements\',\'requirements\')')">Add new requirement</button>
                    <h3>Audience</h3>
                    <div id="audience">
                      <% for (let i = 0; i < content.audience.length; i++){%>
                        <p><%-content.audience[i]%></p>
                      <%}%>
                    </div>
                    <div id="newAudience">

                    </div>
                    <button class="button btn-primary" onclick="promptTitle('newAudience','newAudienceValue','Input audience',
                    'addCourseDetailField(\'newAudienceValue\',\'/api/newAudience\',\'audience\',\'newAudience\',\'audience\')')">Add Audience</button>
                  </div>                  

                  <div id="curriculum" class="tabcontent">
                    <div class="row">
                      <div class="col-6">
                      <nav id="courseSidebar">
                          <ul id="moduleList" class="list-unstyled modComponents"> 
                            <% let modules = content.modules%>
                            <% for (let i = 0; i < modules.length; i++) {%>
                              <% let module_title = modules[i].module_title%>
                              <li id = "moudle-<%=i%>-listRoot">
                                <%- include('./partials/moduleBlock.ejs',{modId:i,module_title:module_title});  %>
                                <ul class = "collapse list-unstyled" id="module<%=i%>Lessons">
                                  <%let lessons = modules[i].lessons; %>
                                  
                                  <div id = "lessonListContentModule<%=i%>">
                                    <% for (let j = 0; j < lessons.length; j++) {%>
                                      <%- include('./partials/lessonBlock.ejs',{modId:i,lessonId:j,lesson_title:lessons[j].lesson_title});  %>
                                    <%}%>
                                  </div>
                                  

                                  <div id="newLesson-<%=i%>">

                                  </div>
                                  <li><button class="button btn-secondary" onclick="promptTitle('newLesson-<%=i%>','newLessonName','Input lessonName', 'addLesson(\'<%=i%>\')')">Add Lesson</button></li>
                                </ul>
                              </li>
                              <%}%>
                          </ul>
                      </nav>

                      <div id="newModule">

                      </div>
                      

                      <button class="button btn-primary" onclick="promptTitle('newModule','newModuleName','Input module name','addModule()')">Add Module</button>
                    </div>

                    <div class="col-6" id="lessonContainer">
                    <% for (i = 0; i < modules.length; i++) {%>
                      <%let lessons = modules[i].lessons; %>
                      
                    <% for (j = 0; j < lessons.length; j++) {%>
                      <%let content = lessons[j].content %>

                        <div id="module<%=i%>-lesson-<%=j%>" style="display:none;" class="lessons">
                        <h2><%- lessons[j].lesson_title%></h2>

                        <% if (lessons[j].content.data === '') {%>
                            <div>
                              <p>Add a new block of content</p>
                              <button type="button btn-secondary" class="lessonContentButton" onclick="openSection(event, 'newVideoModule<%=i%>Lesson<%=j%>', 'lessonBlock', 'lessonContentButton')">Video</button>
                              <button type="button btn-secondary" class="lessonContentButton" onclick="openSection(event, 'newRichTextModule<%=i%>Lesson<%=j%>', 'lessonBlock', 'lessonContentButton')">Rich Text</button>
                              
                                <div id="newVideoModule<%=i%>Lesson<%=j%>" style="display:none;" class="lessonBlock">
                                  <h2>Upload a video</h2>
                                  <input type="file" accept="video/*" id="videoModule<%=i%>Lesson<%=j%>Input" onchange="readVideo('<%=j%>','<%=i%>')" style="display:block">
                                  <video controls id="video-tagModule<%=i%>Lesson<%=j%>" width="100%" height="50%"></video>

                                </div>
                              

                              <div id="newRichTextModule<%=i%>Lesson<%=j%>" style="display:none;" class="lessonBlock">
                                <%- include('./partials/richText.ejs',{content:"",module:i,lesson:j});  %>
                                <button class="btn btn-primary" type="submit" onclick="submitRichText('<%=j%>','<%=i%>')">Save</button>
                              </div>
                            </div>
                          </div>
                            <%}else{%>

                              <% if (lessons[j].content.type === 'serverVideo') {%>
                                <div id="newVideoModule<%=i%>Lesson<%=j%>" class="lessonBlock">
                                  <input type="file" accept="video/*" id="videoModule<%=i%>Lesson<%=j%>Input" onchange="readVideo('<%=j%>','<%=i%>')" style="display:block">
                                  <video controls id="video-tagModule<%=i%>Lesson<%=j%>" width="100%" height="50%" src='<%=lessons[j].content.data%>'></video>

                                </div>
                                
                              
                              <%} else if (lessons[j].content.type === 'richText') {%>
                                  <div id="newRichTextModule<%=i%>Lesson<%=j%>" class="lessonBlock">
                                    <%- include('./partials/richText.ejs', {content:lessons[j].content.data,module:i,lesson:j}); %>
                                    <button class="btn btn-primary" type="submit" onclick="submitRichText('<%=j%>','<%=i%>')">Save</button>
                                  </div>
                            <%}%>
                          </div>
                          <%}%>
                
                    <%}%>
                    <%}%>
                  </div>
                  </div>
                  </div>

                  <div id="pricing" class="tabcontent" style="display:none;">
                    <div id="paymentTable" style="display:block;">
                        <h3>Pricing</h3>
                        <button class="btn btn-primary" onclick="enableAddPayment()">Add Plan</button>
                        <table class = "table" id="payTable">
                          <thead>
                              <tr>
                                  <th scope="col">Plan Name</th>
                                  <th scope="col">Plan Type</th>
                                  <th scope="col">Price</th>
                                  <th scope="col">Status</th>
                              </tr>
                          </thead>
                          <tbody>
                              <% let paymentOptions = content.payment_options %>
                              <% for (var i = 0; i < paymentOptions.length; i++){ %>
                              <tr>
                                  <th scope="row"><%= paymentOptions[i].plan_name %></th>
                                  <td><%= paymentOptions[i].plan_type %></td>
                                  <td><%= paymentOptions[i].pay_amount %></td>
                                  <td><%= paymentOptions[i].status %></td>
                              </tr>
                              <% } %>
                          </tbody>
                      </table>
                    </div>

                    <div id="addPaymentForm" style="display:none;">
                      <h3>Add a payment plan</h3>
                      <button class="btn btn-primary" onclick="addPayment()">Save</button>
                      <button class="btn btn-danger" onclick="displayPaymentTable()">Cancel</button>
                      <br>
                      <label for="planTypes">Choose a payment plan type</label>
                      <select name="planTypes" id="planTypes" onchange="checkPayForm()">
                        <option value="Free">Free</option>
                        <option value="One-time">One time payment</option>
                        <option value="Subscription">Subscription</option>
                      </select>

                      <label for="planNameInput">Enter a plan name</label>
                      <input id="planNameInput" type="text" required placeholder="plan name">

                      <label for="currencySelect" class="paidOption subscriptionOption" style="display:none">Select a currency</label>
                      <select name="currencySelect" id="currencySelect" class="paidOption subscriptionOption" style="display:none">
                        <option value="USD">USD</option>
                        <option value="CAD">CAD</option>
                      </select>

                      <label for="payAmount" class="paidOption subscriptionOption" style="display:none">Enter the amount to pay</label>
                      <input type="text" id="payAmount" class="paidOption subscriptionOption" style="display:none" placeholder="Payment amount">

                      <label for="frequencyPay" class="subscriptionOption" style="display:none">Enter the payment frequency</label>
                      <select name="frequencyPay" id="frequencyPay" class="subscriptionOption" style="display:none">
                        <option value="Monthly">Monthly</option>
                        <option value="Yearly">Yearly</option>
                      </select>


                    </div>

                  </div>
                </div>
                
              </div>
            </div>
      </div>
  </div>

  
</body>



<script>


  async function addPayment(){
    const plan = document.getElementById('planTypes').value
    const planName = document.getElementById('planNameInput').value;
    let body = {};
    let currency = "";
    let payAmount = "";
    let frequency = "";

    switch(plan){
      case 'Free':
        body = {courseId:'<%=courseId%>', planName:planName, planType:'Free'}
        break;
      case 'One-time':
        currency = document.getElementById('currencySelect').value;
        payAmount = document.getElementById('payAmount').value;
        body  = {courseId:'<%=courseId%>', planName:planName, planType:'One-time',currency:currency, payAmount: payAmount};
        break;
      case 'Subscription':
        currency = document.getElementById('currencySelect').value;
        payAmount = document.getElementById('payAmount').value;
        frequency = document.getElementById('frequencyPay').value;
        body  = {courseId:'<%=courseId%>', planName:planName, planType:'Subscription', currency:currency, payAmount: payAmount, frequency:frequency};
        break;
    }

    await fetch('<%= url %>:<%= port %>/api/addPaymentOption', {
        method:'POST',
        body:JSON.stringify(body), 
        headers: {
        'Content-Type': 'application/json'
      },
        credentials:'include'
      });

      let table = document.getElementById('payTable');
      let row = table.insertRow(1);
      let cell1 = row.insertCell(0);
      let cell2 = row.insertCell(1);
      let cell3 = row.insertCell(2);

      cell1.outerHTML = `<th scope="row">${planName}</th>`;
      cell2.innerHTML = plan;
      cell3.innerHTML = payAmount;
      displayPaymentTable();
  }

  function checkPayForm(){
    const plan = document.getElementById('planTypes').value

    if (plan === 'One-time'){
      const hideForm = document.getElementsByClassName("subscriptionOption");

      for (i = 0; i < hideForm.length; i++){
        hideForm[i].style.display = "none";
      }

      const planForm = document.getElementsByClassName("paidOption");

      for (i = 0; i < planForm.length; i++){
        planForm[i].style.display = "block";
      }

    }else if (plan === 'Free'){
      const planForm = document.getElementsByClassName("subscriptionOption");

      for (i = 0; i < planForm.length; i++){
        planForm[i].style.display = "none";
      }

    }else if (plan === 'Subscription'){
      const planForm = document.getElementsByClassName("subscriptionOption");

      for (i = 0; i < planForm.length; i++){
        planForm[i].style.display = "block";
      }
    }
  }

  function enableAddPayment(){
    document.getElementById('addPaymentForm').style.display = 'block';
    document.getElementById('paymentTable').style.display = 'none';
  }

  function displayPaymentTable(){
    document.getElementById('addPaymentForm').style.display = 'none';
    document.getElementById('paymentTable').style.display = 'block';
  }

  async function updateModTitle(moduleId,moduleInputId){
    let newTitle = document.getElementById(moduleInputId).value
    document.getElementById('module-' + moduleId).innerHTML = newTitle;

    await fetch('<%= url %>:<%= port %>/api/updateModuleTitle', {
        method:'POST',
        body:JSON.stringify({moduleId:moduleId, title:newTitle, courseId:'<%=courseId%>'}), 
        headers: {
        'Content-Type': 'application/json'
      },
        credentials:'include'
      });

  }

  function addModBlock(modId, moduleTitle){
    return `
    <a id = "module-${modId}" href="#module${modId}Lessons" data-toggle="collapse" aria-expanded="false" class="moddropdown-toggle" style="display:inline">${moduleTitle}</a>
    <a style="display:inline" href="#" onclick="promptTitle('module-${modId}','newModTitleInput${modId}','${moduleTitle}','updateModTitle(\'${moduleId}\',\'newModTitleInput${moduleId}\')')"><i class="fa fa-edit"></i></a>
    <a style="display:inline" href="#" onclick="deleteModule('${modId}')"><i class="fa fa-trash"></i></a>
    `
}

  async function updateLessonTitle(moduleId, lessonId, lessonInputId){
    let newTitle = document.getElementById(lessonInputId).value;
    document.getElementById('mod-' + moduleId + '-lesson-' + lessonId).innerHTML = newTitle;

    await fetch('<%= url %>:<%= port %>/api/updateLessonTitle', {
        method:'POST',
        body:JSON.stringify({moduleId:moduleId, lessonId: lessonId, title:newTitle, courseId:'<%=courseId%>'}), 
        headers: {
        'Content-Type': 'application/json'
      },
        credentials:'include'
      });

  }

  async function submitRichText(lessonId,moduleId){
      const richTextData = JSON.stringify({data:quill.root.innerHTML,courseId:'<%=courseId%>',lessonId:lessonId,moduleId:moduleId});

      await fetch('<%= url %>:<%= port %>/api/uploadLessonRichText', {
        method:'POST',
        body:richTextData, 
        headers: {
        'Content-Type': 'application/json'
      },
        credentials:'include'
      });
  }

  async function readVideo(lessonId, moduleId){
    const video = document.getElementById('videoModule' + moduleId + 'Lesson' + lessonId + 'Input')

    const formData = new FormData();
    formData.append("video",video.files[0]);
    formData.append("lessonId", lessonId);
    formData.append("moduleId", moduleId);
    formData.append("courseId",'<%=courseId%>')

    const res = await fetch('<%= url %>:<%= port %>/api/uploadVideo', {
      method:'POST',
      body:formData,
      credentials:'include'
    });

    const resJson = await res.json();
    document.getElementById('video-tagModule' + moduleId + 'Lesson' + lessonId).src = resJson.video;
  }

  async function addLesson(modId){
    let lessonTitle = document.getElementById('newLessonName').value
    let res = await fetch('<%= url %>:<%= port %>/api/addLesson', {
      method:'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      credentials: 'include',
      body:JSON.stringify({courseId: '<%=courseId%>',lessonTitle:lessonTitle, moduleId:modId})
    });

    let lessonRes = await res.json();
    const lessonId = lessonRes.id;

    document.getElementById("lessonListContentModule" + modId).innerHTML += `
    <li id="mod-${modId}-lesson-${lessonId}-listRoot" onclick="showLesson(event, 'module${modId}-lesson-${lessonId}')">
      <a id="mod-${modId}-lesson-${lessonId}" class="modsidebarlink modindentitem" style="display:inline">${lessonTitle}</a>
      <a style="display:inline" href="#" onclick="promptTitle('mod-${modId}-lesson-${lessonId}','newLessonTitleInput${modId}','${lessonTitle}','updateLessonTitle(\\'${modId}\\', \\'${lessonId}\\' ,\\'newLessonTitleInput${modId}\\')')"><i class="fa fa-edit"></i></a>
      <a style="display:inline" href="#" onclick="deleteLesson('${modId}','${lessonId}')"><i class="fa fa-trash"></i></a>
    </li>`

    document.getElementById("lessonContainer").innerHTML += `
    <div>
      <p>Add a new block of content</p>
      <button type="button btn-secondary" class="lessonContentButton" onclick="openSection(event, 'newVideoModule${modId}Lesson${lessonId}', 'lessonBlock', 'lessonContentButton')">Video</button>
      <button type="button btn-secondary" class="lessonContentButton" onclick="openSection(event, 'newRichTextModule${modId}Lesson${lessonId}', 'lessonBlock', 'lessonContentButton')">Rich Text</button>
      
        <div id="newVideoModule${modId}Lesson${lessonId}" style="display:none;" class="lessonBlock">
          <h2>Upload a video</h2>
          <input type="file" accept="video/*" id="videoModule${modId}Lesson${lessonId}Input" onchange="readVideo('${lessonId}','${modId}')" style="display:block">
          <video controls id="video-tagModule${modId}Lesson${lessonId}" width="100%" height="50%"></video>

        </div>
      

      <div id="newRichTextModule${modId}Lesson${lessonId}" style="display:none;" class="lessonBlock">
        <%- include('./partials/richText.ejs',{content:"",module:${modId},lesson:${lessonId}});  %>
        <button class="btn btn-primary" type="submit" onclick="submitRichText('${lessonId}','${modId}')">Save</button>
      </div>
    </div>
  </div>
    `

    document.getElementById("newLesson-" + modId).innerHTML = "";
 
  }

  function promptTitle(location, inId, placeholder, callFunc){
    document.getElementById(location).innerHTML = `<input id = "${inId}" type="text" placeholder="${placeholder}"></input> 
    <button class="button btn-secondary" onclick="${callFunc}">Save</button>`
  }

  async function addCourseDetailField(target, apiPath,field,clearId,addId){
    let value = document.getElementById(target).value;

    let body = {courseId:'<%=courseId%>'};
    body[field] = value;

    await fetch('<%= url %>:<%= port %>' + apiPath, {
                method:'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: 'include',
                body:JSON.stringify(body)
            });
            document.getElementById(clearId).innerHTML = "";
            document.getElementById(addId).innerHTML += `<p>${value}</p>`;
  }

  async function deleteModule(modId){
    document.getElementById('moudle-' + modId + '-listRoot').remove();
    await fetch('<%= url %>:<%= port %>/api/deleteModule', {
                method:'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: 'include',
                body:JSON.stringify({courseId:'<%=courseId%>', moduleId:modId})
            });
  }

  async function deleteLesson(modId,lessonId){
    document.getElementById('mod-' + modId + '-lesson-' + lessonId + '-listRoot').remove();
    await fetch('<%= url %>:<%= port %>/api/deleteLesson', {
                method:'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: 'include',
                body:JSON.stringify({courseId:'<%=courseId%>', moduleId:modId, lessonId:lessonId})
            });
  }
  
  async function addModule(){
    let moduleTitle = document.getElementById('newModuleName').value
    let res = await fetch('<%= url %>:<%= port %>/api/addModule', {
                method:'POST',
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: 'include',
                body:JSON.stringify({courseId:'<%=courseId%>', moduleTitle:moduleTitle})
            });
            
            let json = await res.json();
            let modId = json.id;
            
            document.getElementById('newModule').innerHTML = "";
            document.getElementById("moduleList").innerHTML += `
             <li>
                <a id="module${modId}" class="moddropdown-toggle collapsed" href="#module${modId}Lessons" data-toggle="collapse" aria-expanded="false">${moduleTitle}</a>
                <ul id="module${modId}Lessons" class="list-unstyled collapse">
                  <div id="lessonListContentModule${modId}">
                  <li onclick="showLesson(event,'module-${modId}-lesson-0')">
                    <a class="modsidebarlink modindentitem">Lesson1</a>  
                  </li>
                  </div>
                  <div id="newLesson-${modId}">

                  </div>
                  <li><button class="button btn-secondary" onclick="promptLessonTitle('${modId}')">Add Lessson</button> </li>  
                </ul>
              </li>
            `

            document.getElementById('lessonContainer').innerHTML += `
              <div id="module-${modId}-lesson-0" style="display:none;" class="lessons">
                <h2>Test</h2>
              </div>
            `
  }

  function showLesson(event,lesson){
    let i, tabContent, tabLinks;
    lessonContent = document.getElementsByClassName("lessons");

    for (i = 0; i < lessonContent.length; i++){
      lessonContent[i].style.display = "none";
    }
    
    document.getElementById(lesson).style.display = "block";
  }


  function openSection(event, page, contentClass, tabClass){
    let i, tabContent, tabLinks;
    tabContent = document.getElementsByClassName(contentClass);

    for (i = 0; i < tabContent.length; i++){
      tabContent[i].style.display = "none";
    }

    tabLinks = document.getElementsByClassName(tabClass);
    for (i = 0; i < tabLinks.length; i++){
      tabLinks[i].className = tabLinks[i].className.replace(" active", "");
    }

    document.getElementById(page).style.display = "block";
    event.currentTarget.className += " active";
  }

</script>


</html>